<html>
    <head>
        <script src="./lib/p5.min.js"></script>
        <script src="./catalog.js"></script>

        <style>
            .color {
                float: left;
                width: 30px;
                height: 30px;
            }
        </style>

        <script>

            let gridX = 48;
            let gridY = 48;

            const catalogRows = catalog.split('\n');
            // console.log(catalogRows)

            const catalogObj = catalogRows.reduce((final, row) => {
                const cols = row.split(',');
                final[cols[0]] = {
                    price: parseFloat(cols[6].replace('"', '').replace('€', '').trim())
                }
                return final;
            }, {})

            console.log(catalogObj);

            function setup() {

                const gridXInput = createInput('48');
                gridXInput.input(function() {gridX = parseInt(this.value())});
                const gridYInput = createInput('48');
                gridYInput.input(function() {gridY = parseInt(this.value())});
                const imageFile = createFileInput(file => {

                    if (file.type === 'image') {
                        loadImage(file.data, (img) => {
                            const blockSizeWidth = img.width / gridX;
                            const blockSizeHeight = img.height / gridY;

                            const colors = {}

                            for ( let i = Math.round(blockSizeWidth / 2); i < img.width; i = i + blockSizeWidth ) {
                                for ( let j = Math.round(blockSizeHeight / 2); j < img.height; j = j + blockSizeHeight) {

                                    let c = img.get(i, j);
                                    colors[c] = colors[c] === undefined ? 1 : colors[c] + 1

                                }
                            }

                            let totalPoints = 0;
                            let totalPrice = 0;

                            createDiv()

                            Object.keys(colors).forEach(c => {

                                const container = createDiv()

                                const block = createDiv();
                                block.parent(container);
                                block.class('color');
                                block.style('background-color', `rgba(${c})`);
                                
                                const comp = c.split(',').map(num => parseInt(num));
                                var hx = "#" + hex(comp[0], 2) + hex(comp[1], 2) + hex(comp[2], 2);

                                const price =  (catalogObj[hx] ?  catalogObj[hx].price : 0) * colors[c];
                                const p = createP(`${c} - ${hx} : ${colors[c]} (€ ${price})`)
                                if (price === 0) {
                                    const s = createSpan('⚠️⚠️⚠️')
                                    s.parent(p)
                                }
                                
                                p.parent(container)
                                totalPoints += colors[c];
                                totalPrice += price;
                            })

                            createP(`TOTAL : ${totalPoints} (€ ${totalPrice})`)
                            createP(`math : ${gridX} x ${gridY} = ${gridX * gridY}`)

                        });

                        
                    }

                });


            }
            

        </script>
    </head>
    
</html>