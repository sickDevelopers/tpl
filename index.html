<html>
    <head>
        <script src="./lib/p5.min.js"></script>
        <script src="./catalog.js"></script>

        <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

<script src="https://unpkg.com/giphy-random/dist/giphy-random.umd.min.js"></script>

        <!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Comic+Neue:ital,wght@1,700&display=swap" rel="stylesheet">
        <style>
            .color {
                float: left;
                width: 30px;
                height: 30px;
            }

            tfoot {
                background-color: #35c0bb
            }

            #img-container {
                float: left;
                background-color: gray;
            }

            #instructions {
                float: right;
                background-color: #000;
                width: 1000px;
                height: 1000px;
            }

        </style>

        
    </head>
    <body>
        <h1 style="font-family: 'Comic Neue', cursive;">Cercavo il comic sans ma non è aggratis</h1>
        <div id="img-container"></div>
        <div class="" id="instructions"></div>

        <script>

            // CODICE IMPORTANTISSIMO LUCAAAAAAAAAAAA
            (async () => {
                const API_KEY = "H1FB5bcRZ0jP91bF8GpYvFXLNjJ3R3Ez";

                const { data } = await giphyRandom(API_KEY, {
                    tag: 'fail'
                });

                console.log(data);

                const embed = createElement('embed');
                embed.attribute('src', data.embed_url)
            })();
            // FINE CODICE IMPORTATISSIMO

            let gridX = 48;
            let gridY = 48;

            const catalogRows = catalog.split('\n');
            // console.log(catalogRows)

            const catalogObj = catalogRows.reduce((final, row) => {
                const cols = row.split(',');
                final[cols[0].toUpperCase()] = {
                    price: parseFloat(cols[6].replace('"', '').replace('€', '').trim()),
                    element: cols[4],
                    series: cols[5]
                }
                return final;
            }, {})

            function setup() {

                const canvas = createCanvas(200, 200);
                canvas.parent('img-container');


                createElement('label', 'colonne')
                const gridXInput = createInput('48');
                gridXInput.input(function() {gridX = parseInt(this.value())});
                createElement('label', 'righe')
                const gridYInput = createInput('48');
                gridYInput.input(function() {gridY = parseInt(this.value())});
                const imageFile = createFileInput(file => {

                    if (file.type === 'image') {
                        loadImage(file.data, (img) => {
                            const blockSizeWidth = img.width / gridX;
                            const blockSizeHeight = img.height / gridY;

                            image(img,0,0, 200, 200)

                            const colors = {}

                            const colorGrid = Array(gridX).fill().map(() => Array(gridY).fill());

                            let x = 0, y = 0;

                            for ( let i = Math.round(blockSizeWidth / 2); i < img.width; i = i + blockSizeWidth ) {
                                y = 0;
                                for ( let j = Math.round(blockSizeHeight / 2); j < img.height; j = j + blockSizeHeight) {
                                    
                                    
                                    let c = img.get(i, j);
                                    colors[c] = colors[c] === undefined ? 1 : colors[c] + 1
                                    colorGrid[x][y] = c;
                                    y++;
                                }
                                x++;
                            }

                            console.log(colors);  

                            console.log('colorGrid', colorGrid)

                            let totalPoints = 0;
                            let totalPrice = 0;

                            createDiv()
                            const table = createElement('table');
                            table.class('table table-striped');

                            const thead = createElement('thead',
                                `
                                    <tr>
                                        <th></th>
                                        <th>indice</th>  
                                        <th>RGB</th>
                                        <th>HEX</th>
                                        <th>numero</th>
                                        <th>prezzo</th>
                                        <th>elemento</th>
                                        <th>num. serie</th>    
                                    </tr>
                                `
                            );
                            thead.parent(table);

                            const colorKeys = Object.keys(colors);


                            tbody = createElement('tbody');
                            tbody.parent(table);

                            Object.keys(colors).forEach((c, index) => {

                                const tr = createElement('tr');
                                tr.parent(tbody)

                                const colorTd = createElement('td');
                                colorTd.parent(tr);
                                const colorBlock = createDiv();
                                colorBlock.parent(colorTd);
                                colorBlock.class('color');
                                colorBlock.style('background-color', `rgba(${c})`);

                                const indexBlock = createElement('td', index +1 );
                                indexBlock.parent(tr);

                                const rgbBlock = createElement('td');
                                rgbBlock.parent(tr);
                                rgbBlock.html(c)

                               
                                
                                const comp = c.split(',').map(num => parseInt(num));
                                var hx = "#" + hex(comp[0], 2) + hex(comp[1], 2) + hex(comp[2], 2);
                                const hexTd = createElement('td', hx);
                                hexTd.parent(tr);
                                
                                const countTd = createElement('td');
                                countTd.parent(tr)
                                countTd.html(colors[c])
                                
                                let price = 0;
                                const priceTd = createElement('td');
                                if (catalogObj[hx]) {
                                    price = catalogObj[hx].price * colors[c];
                                    priceTd.html(`${price} €`)
                                }
                                priceTd.parent(tr);

                                const elementTd = createElement('td');
                                if (catalogObj[hx]) {
                                    elementTd.html(catalogObj[hx].element);
                                }
                                elementTd.parent(tr);

                                const seriesTd = createElement('td');
                                if (catalogObj[hx]) {
                                    seriesTd.html(catalogObj[hx].series);
                                }
                                seriesTd.parent(tr);
                                
                                totalPoints += colors[c];
                                totalPrice += price;
                            })

                            tfooter = createElement('tfoot', `
                                <tr>
                                    <td>TOTALI</td>
                                    <td></td>
                                    <td></td>
                                    <td>${totalPoints}</td>
                                    <td>${totalPrice} €</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                            `);
                            tfooter.parent(table);



                            const instructions = document.getElementById('instructions');
                            const instructionCanvas = document.createElement('canvas');
                            instructionCanvas.height = 1000;
                            instructionCanvas.width = 1000;

                            instructions.appendChild(instructionCanvas);
                            const ctx = instructionCanvas.getContext('2d');

                            const gridBlockWidth = 20;
                            const gridBlockHeight = 20;

                            


                            for (let i = 0; i < colorGrid.length; i++) {
                                for (let j = 0; j < colorGrid[0].length; j++) {
                                    const [r, g, b, a] = colorGrid[i][j];
                                    ctx.fillStyle = `rgb(${r}, ${g}, ${b})`;
                                    ctx.beginPath();
                                    ctx.arc(
                                        i * gridBlockWidth + gridBlockWidth, 
                                        j * gridBlockHeight + gridBlockHeight,
                                        gridBlockWidth / 2,
                                        0, 2 * Math.PI, false
                                    );
                                    ctx.fill();

                                    ctx.fillStyle = `black`;

                                    if (r === 0, g === 0, b === 0) {
                                        ctx.fillStyle = 'white';
                                    }

                                    ctx.fontWeight = 'bold';
                                    ctx.font = '10px Arial';

                                    const index = colorKeys.indexOf(colorGrid[i][j].toString())

                                    ctx.fillText(
                                        index + 1, 
                                        i * gridBlockWidth + gridBlockWidth - 2, 
                                        j * gridBlockHeight + gridBlockHeight + 5
                                        )


                                }
                            }



                            button = createButton('ESPORTA STA ROBA E DIVENTA IMPROVVISAMENTE RICCO!');
                            button.mouseReleased(function () {
                                const csvContent = Object.keys(colors).reduce((finalString, c) => {
                                    const comp = c.split(',').map(num => parseInt(num));
                                    var hx = "#" + hex(comp[0], 2) + hex(comp[1], 2) + hex(comp[2], 2);
                                    
                                    if (catalogObj[hx]) {
                                        finalString += `${catalogObj[hx].element}\t${colors[c]}`;
                                    }
                                    finalString += '\n';
                                    return finalString

                                }, '')

                                console.log(csvContent)

                                var encodedUri = encodeURI("data:text/csv;charset=utf-8," + csvContent);
                                var link = document.createElement("a");
                                link.setAttribute("href", encodedUri);
                                link.setAttribute("download", "lego_order.txt");
                                document.body.appendChild(link); // Required for FF

                                link.click(); // This will download the data file named "my_data.csv".


                                
                            })


                            
                            
                            
                            

                        });

                        
                    }

                });


            }


            
            

        </script>
    </body>
</html>